<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Layout Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- BLUEPRINT THEME --- */
        :root {
            --bg-color: #0d1b2a; /* Deep Blueprint Blue */
            --grid-color: rgba(66, 135, 245, 0.1);
            --card-bg-color: rgba(23, 49, 79, 0.85); /* Translucent Dark Blue */
            --text-color: #E6F1FF; /* Light Steel Blue */
            --text-color-light: #8892B0; /* Slate Blue */
            --border-color: #1e3a5f; /* Lighter Navy */
            --accent-color: #4287f5; /* Bright Blueprint Blue */
            --button-text-color: #ffffff;
            --button-hover-bg-color: #649ff5;
            --input-bg-color: rgba(13, 27, 42, 0.8);
            --accordion-expanded-bg: rgba(30, 58, 95, 0.9);
            --green-text: #6ee7b7;
            --red-text: #fca5a5;
            --btn-red-bg: #ef4444;
            --btn-red-hover-bg: #dc2626;
            --btn-green-bg: #22c55e;
            --btn-green-hover-bg: #16a34a;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overscroll-behavior: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--button-hover-bg-color); }

        /* --- LAYOUT --- */
        #app-container { display: flex; flex-direction: column-reverse; height: 100vh; }
        @media (min-width: 1024px) { #app-container { flex-direction: row; } }

        #main-canvas {
            flex-grow: 1;
            display: flex;
            align-items: center; /* Center canvas vertically */
            justify-content: center; /* Center canvas horizontally */
            overflow: hidden; /* Important for pan/zoom */
            cursor: grab;
            background-color: #ffffff; /* White Background */
            background-image:
                linear-gradient(#f3f4f6 1px, transparent 1px),
                linear-gradient(90deg, #f3f4f6 1px, transparent 1px);
            background-size: 2rem 2rem;
            position: relative; /* For positioning zoom controls */
        }
        #main-canvas.panning { cursor: grabbing; }

        #resizable-canvas {
            overflow: visible; /* Allow content to be seen when panned */
            padding: 1rem;
            border-radius: 0.5rem;
            height: auto;
            background-color: #e0f2fe; /* Light Blue Grid Background */
            transition: transform 0.1s linear; /* Smooth zoom */
            flex-shrink: 0; /* Prevent canvas from shrinking when panned */
        }

        #grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 4px;
            width: 800px; /* Give it a default size */
         }

        /* --- THEMED COMPONENTS --- */
        .grid-cell {
            background-color: transparent; /* Cells are transparent to show grid background */
            aspect-ratio: 1 / 1;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative;
        }
        .grid-cell.drag-over {
            background-color: rgba(66, 135, 245, 0.2);
            border-color: var(--accent-color);
        }
        .extra-cell { border-style: solid; }
        
        #delete-zone {
            grid-column: 1;
            grid-row: 2 / span 8;
            border: 2px dashed var(--btn-red-bg);
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--btn-red-bg);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        #delete-zone.drag-over-delete {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--btn-red-hover-bg);
            border-style: solid;
            font-weight: 600;
        }

        #side-panel {
            width: 100%;
            max-height: 50vh;
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 1024px) {
            #side-panel {
                width: 384px;
                flex-shrink: 0;
                max-height: 100vh;
                border-top: none;
                border-left: 1px solid var(--border-color);
            }
        }

        .scroll-header {
            padding: 0.75rem 2rem;
            margin: 0 auto;
            position: relative;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(66, 135, 245, 0.2);
            background-color: var(--accent-color);
            background-image: 
              linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 1rem 1rem;
            background-position: center center;
        }
        .scroll-header::before, .scroll-header::after {
            content: ''; position: absolute; top: 0; height: 100%; width: 20px;
            background-color: var(--accent-color); box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }
        .scroll-header::before { left: -20px; border-top-left-radius: 10px; border-bottom-left-radius: 10px; border-right: 2px solid #2a6dcc; }
        .scroll-header::after { right: -20px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-left: 2px solid #2a6dcc; }
        .scroll-header h1 { 
            font-family: 'Oswald', sans-serif; font-size: 1.75rem; font-weight: 700; margin: 0; 
            color: white; letter-spacing: 1px; text-transform: uppercase;
        }

        .tab-btn {
            background-color: var(--input-bg-color);
            border-bottom: 2px solid transparent;
            color: var(--text-color-light);
            transition: all 0.2s;
        }
        .tab-btn.active {
            font-weight: 600;
            color: var(--text-color);
            border-bottom-color: var(--accent-color);
            background-color: var(--bg-color);
        }
        
        .accordion-header {
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }
        .accordion-header:hover { background-color: var(--border-color); }
        .accordion-content {
            background-color: transparent;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .room-item-source {
            border-color: var(--border-color);
            background-color: var(--bg-color);
            cursor: grab;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .room-item-source:active { cursor: grabbing; transform: scale(0.95); }

        .btn {
            padding: 0.5rem 1rem; font-weight: 600; border: none; border-radius: 0.25rem;
            color: var(--button-text-color); cursor: pointer; transition: background-color 0.2s ease;
            text-align: center; display: inline-block;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-blue { background-color: var(--accent-color); }
        .btn-blue:hover:not(:disabled) { background-color: var(--button-hover-bg-color); }
        .btn-red { background-color: var(--btn-red-bg); }
        .btn-red:hover:not(:disabled) { background-color: var(--btn-red-hover-bg); }
        .btn-green { background-color: var(--btn-green-bg); }
        .btn-green:hover:not(:disabled) { background-color: var(--btn-green-hover-bg); }
        .btn-indigo { background-color: #4f46e5; }

        #custom-context-menu {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        #custom-context-menu button { color: var(--text-color); }
        #custom-context-menu button:hover { background-color: var(--accordion-expanded-bg); }
        #custom-context-menu button[data-action="delete"] { color: var(--red-text); }
        #custom-context-menu button[data-action="delete"]:hover { background-color: rgba(239, 68, 68, 0.1); }

        #touch-ghost {
            position: absolute; pointer-events: none; opacity: 0.8; z-index: 1000;
            transform: translate(-50%, -50%); transition: opacity 0.2s;
        }

        .placed-room {
            width: 100%; height: 100%; position: relative; user-select: none;
            display: flex; align-items: center; justify-content: center; cursor: grab;
        }
        .placed-room:active { cursor: grabbing; }
        .placed-room img {
            max-width: 100%; max-height: 100%; pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .placed-room .rotate-btn {
            position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.6);
            color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; z-index: 10;
        }
        .placed-room:hover .rotate-btn { opacity: 1; }
        .placed-room .rotate-left { left: -10px; }
        .placed-room .rotate-right { right: -10px; }
        .hidden { display: none !important; }

        .input-field {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .input-field:focus { outline: 2px solid var(--accent-color); border-color: transparent; }

        .saved-plan-item {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
        }

        #zoom-controls {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: var(--card-bg-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #zoom-controls input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 120px; }
        #zoom-controls input[type="range"]::-webkit-slider-runnable-track { background: var(--border-color); height: 0.25rem; border-radius: 0.25rem; }
        #zoom-controls input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: var(--accent-color); height: 1rem; width: 1rem; border-radius: 9999px; }
        #zoom-controls input[type="number"] {
            width: 70px;
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 0.25rem;
            text-align: center;
            padding: 0.25rem;
        }
        #zoom-controls input[type="number"]::-webkit-inner-spin-button, 
        #zoom-controls input[type="number"]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Main Canvas Area -->
        <main id="main-canvas">
            <div id="resizable-canvas">
                <div id="grid-container"></div>
            </div>

            <!-- Zoom Controls -->
            <div id="zoom-controls">
                <input type="range" id="zoom-slider" min="0.2" max="3" step="0.01" value="1">
                <input type="number" id="zoom-input" min="20" max="300" value="100">
                <button id="reset-view-btn" class="btn btn-blue" title="Reset View">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M15.836 8.336a.5.5 0 0 0-.011-.05L15.8 8.25a.5.5 0 0 0-.24-.24l-.035-.011a.5.5 0 0 0-.05-.011H15.4a.5.5 0 0 0-.055-.008.5.5 0 0 0-.06-.005h-.008a.5.5 0 0 0-.06-.003h-.01a.5.5 0 0 0-.06-.002h-.011a.5.5 0 0 0-.06-.001H15a.5.5 0 0 0-.06 0h-.01a.5.5 0 0 0-.06 0h-.01a.5.5 0 0 0-.06 0H14.5a.5.5 0 0 0-.06 0h-.01a.5.5 0 0 0-.06 0h-.01a.5.5 0 0 0-.06 0h-.01a.5.5 0 0 0-.059.001h-.011a.5.5 0 0 0-.06.002h-.01a.5.5 0 0 0-.06.003h-.008a.5.5 0 0 0-.06.005.5.5 0 0 0-.055.008h-.025a.5.5 0 0 0-.05.011l-.035.011a.5.5 0 0 0-.24.24l-.025.035a.5.5 0 0 0-.011.05V8.5a.5.5 0 0 0 .001.059v.011a.5.5 0 0 0 .002.06v.01a.5.5 0 0 0 .003.06v.008a.5.5 0 0 0 .005.06.5.5 0 0 0 .008.055v.025a.5.5 0 0 0 .011.05l.011.035a.5.5 0 0 0 .24.24l.035.025a.5.5 0 0 0 .05.011h.025a.5.5 0 0 0 .055.008.5.5 0 0 0 .06.005h.008a.5.5 0 0 0 .06.003h.01a.5.5 0 0 0 .06.002h.011a.5.5 0 0 0 .06.001H15a.5.5 0 0 0 .06 0h.01a.5.5 0 0 0 .06 0h.01a.5.5 0 0 0 .06 0h.01a.5.5 0 0 0 .059-.001h.011a.5.5 0 0 0 .06-.002h.01a.5.5 0 0 0 .06-.003h.008a.5.5 0 0 0 .06-.005.5.5 0 0 0 .055-.008h.025a.5.5 0 0 0 .05-.011l.035-.011a.5.5 0 0 0 .24-.24l.025-.035a.5.5 0 0 0 .011-.05V8.5a.5.5 0 0 0 0-.06v-.01a.5.5 0 0 0 0-.06v-.01a.5.5 0 0 0-.001-.06V8.25a.5.5 0 0 0-.002-.06v-.008a.5.5 0 0 0-.003-.06.5.5 0 0 0-.005-.06.5.5 0 0 0-.008-.055zM8 4.5a.5.5 0 0 0-1 0V7H4.5a.5.5 0 0 0 0 1H7v2.5a.5.5 0 0 0 1 0V8h2.5a.5.5 0 0 0 0-1H8z"/>
                        <path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 1 0 0 14A7 7 0 0 0 8 1"/>
                    </svg>
                </button>
            </div>
        </main>

        <!-- Side Panel -->
        <aside id="side-panel">
             <div class="p-4 sticky top-0 bg-transparent z-10 border-b border-transparent text-center">
                <div class="scroll-header">
                     <h1>Layout Planner</h1>
                </div>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-border-color flex-shrink-0">
                <button class="tab-btn active flex-1 py-2 px-4 text-center" data-tab="rooms">Rooms</button>
                <button class="tab-btn flex-1 py-2 px-4 text-center" data-tab="options">Options</button>
            </div>

            <!-- Tab Content -->
            <div id="room-list" class="p-4 tab-content overflow-y-auto flex-grow min-h-0">
                <!-- Room accordions will be generated here -->
            </div>
            <div id="options-content" class="p-4 tab-content hidden overflow-y-auto flex-grow min-h-0">
                 <h2 class="text-lg font-semibold mt-6 mb-2" style="font-family: 'Oswald', sans-serif; color: var(--text-color);">Share Layout</h2>
                 <p class="text-sm text-text-color-light mb-4">Copy a shareable link of your current layout to your clipboard.</p>
                 <button id="share-btn" class="w-full btn btn-green">Copy Link</button>

                 <h2 class="text-lg font-semibold mt-6 mb-2" style="font-family: 'Oswald', sans-serif; color: var(--text-color);">Reset Floor Plan</h2>
                 <p class="text-sm text-text-color-light mb-4">Clear all rooms and restore the default layout.</p>
                 <button id="clear-btn" class="w-full btn btn-red">Reset Floor Plan</button>

                 <!-- Saved Plans Section -->
                 <h2 class="text-lg font-semibold mt-6 mb-2" style="font-family: 'Oswald', sans-serif; color: var(--text-color);">Saved Plans</h2>
                 <p class="text-sm text-text-color-light mb-4">Save and load your favorite layouts.</p>
                 <div class="flex gap-2 mb-4">
                     <input type="text" id="plan-name-input" class="input-field w-full rounded px-2 py-1" placeholder="Enter plan name...">
                     <button id="save-plan-btn" class="btn btn-blue" disabled>Save</button>
                 </div>
                 <div id="saved-plans-list" class="flex flex-col gap-2">
                     <!-- Saved plans will be listed here -->
                 </div>
            </div>
        </aside>
    </div>

    <!-- Custom Right-Click Context Menu -->
    <div id="custom-context-menu" class="hidden absolute rounded-lg shadow-xl py-2 z-50 w-40">
        <button data-action="rotate-left" class="flex items-center gap-2 w-full text-left px-4 py-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466"/></svg>
            Rotate Left
        </button>
        <button data-action="rotate-right" class="flex items-center gap-2 w-full text-left px-4 py-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
            Rotate Right
        </button>
        <div class="border-t my-1" style="border-color: var(--border-color);"></div>
        <button data-action="delete" class="flex items-center gap-2 w-full text-left px-4 py-2 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
            Delete Room
        </button>
    </div>

    <script>
        const roomData = [
            // ... (room data remains unchanged)
            { "name": "The Foundation", "type": "Rooms 001-012", "imagePath": "./room_images/The_Foundation.png" },
            { "name": "Entrance Hall", "type": "Rooms 001-012", "imagePath": "./room_images/Entrance_Hall.png" },
            { "name": "Spare Room", "type": "Rooms 001-012", "imagePath": "./room_images/Spare_Room.png" },
            { "name": "Rotunda", "type": "Rooms 001-012", "imagePath": "./room_images/Rotunda.png" },
            { "name": "Parlor", "type": "Rooms 001-012", "imagePath": "./room_images/Parlor.png" },
            { "name": "Billiard Room", "type": "Rooms 001-012", "imagePath": "./room_images/Billiard_Room.png" },
            { "name": "Gallery", "type": "Rooms 001-012", "imagePath": "./room_images/Gallery.png" },
            { "name": "Room 8", "type": "Rooms 001-012", "imagePath": "./room_images/Room_8.png" },
            { "name": "Closet", "type": "Rooms 001-012", "imagePath": "./room_images/Closet.png" },
            { "name": "Walk-in Closet", "type": "Rooms 001-012", "imagePath": "./room_images/Walk-in_Closet.png" },
            { "name": "Attic", "type": "Rooms 001-012", "imagePath": "./room_images/Attic.png" },
            { "name": "Storeroom", "type": "Rooms 001-012", "imagePath": "./room_images/Storeroom.png" },
            { "name": "Nook", "type": "Rooms 013-024", "imagePath": "./room_images/Nook.png" },
            { "name": "Garage", "type": "Rooms 013-024", "imagePath": "./room_images/Garage.png" },
            { "name": "Music Room", "type": "Rooms 013-024", "imagePath": "./room_images/Music_Room.png" },
            { "name": "Locker Room", "type": "Rooms 013-024", "imagePath": "./room_images/Locker_Room.png" },
            { "name": "Den", "type": "Rooms 013-024", "imagePath": "./room_images/Den.png" },
            { "name": "Wine Cellar", "type": "Rooms 013-024", "imagePath": "./room_images/Wine_Cellar.png" },
            { "name": "Trophy Room", "type": "Rooms 013-024", "imagePath": "./room_images/Trophy_Room.png" },
            { "name": "Ballroom", "type": "Rooms 013-024", "imagePath": "./room_images/Ballroom.png" },
            { "name": "Pantry", "type": "Rooms 013-024", "imagePath": "./room_images/Pantry.png" },
            { "name": "Rumpus Room", "type": "Rooms 013-024", "imagePath": "./room_images/Rumpus_Room.png" },
            { "name": "Vault", "type": "Rooms 013-024", "imagePath": "./room_images/Vault.png" },
            { "name": "Office", "type": "Rooms 013-024", "imagePath": "./room_images/Office.png" },
            { "name": "Drawing Room", "type": "Rooms 025-036", "imagePath": "./room_images/Drawing_Room.png" },
            { "name": "Study", "type": "Rooms 025-036", "imagePath": "./room_images/Study.png" },
            { "name": "Library", "type": "Rooms 025-036", "imagePath": "./room_images/Library.png" },
            { "name": "Chamber of Mirrors", "type": "Rooms 025-036", "imagePath": "./room_images/Chamber_of_Mirrors.png" },
            { "name": "The Pool", "type": "Rooms 025-036", "imagePath": "./room_images/The_Pool.png" },
            { "name": "Drafting Studio", "type": "Rooms 025-036", "imagePath": "./room_images/Drafting_Studio.png" },
            { "name": "Utility Closet", "type": "Rooms 025-036", "imagePath": "./room_images/Utility_Closet.png" },
            { "name": "Boiler Room", "type": "Rooms 025-036", "imagePath": "./room_images/Boiler_Room.png" },
            { "name": "Pump Room", "type": "Rooms 025-036", "imagePath": "./room_images/Pump_Room.png" },
            { "name": "Security", "type": "Rooms 025-036", "imagePath": "./room_images/Security.png" },
            { "name": "Workshop", "type": "Rooms 025-036", "imagePath": "./room_images/Workshop.png" },
            { "name": "Laboratory", "type": "Rooms 025-036", "imagePath": "./room_images/Laboratory.png" },
            { "name": "Sauna", "type": "Rooms 037-046", "imagePath": "./room_images/Sauna.png" },
            { "name": "Coat Check", "type": "Rooms 037-046", "imagePath": "./room_images/Coat_Check.png" },
            { "name": "Mail Room", "type": "Rooms 037-046", "imagePath": "./room_images/Mail_Room.png" },
            { "name": "Freezer", "type": "Rooms 037-046", "imagePath": "./room_images/Freezer.png" },
            { "name": "Dining Room", "type": "Rooms 037-046", "imagePath": "./room_images/Dining_Room.png" },
            { "name": "Observatory", "type": "Rooms 037-046", "imagePath": "./room_images/Observatory.png" },
            { "name": "Conference Room", "type": "Rooms 037-046", "imagePath": "./room_images/Conference_Room.png" },
            { "name": "Aquarium", "type": "Rooms 037-046", "imagePath": "./room_images/Aquarium.png" },
            { "name": "Antechamber", "type": "Rooms 037-046", "imagePath": "./room_images/Antechamber.png" },
            { "name": "Room 46", "type": "Rooms 037-046", "imagePath": "./room_images/Room_46.png" },
            { "name": "Bedroom", "type": "Bedrooms", "imagePath": "./room_images/Bedroom.png" },
            { "name": "Boudoir", "type": "Bedrooms", "imagePath": "./room_images/Boudoir.png" },
            { "name": "Guest Bedroom", "type": "Bedrooms", "imagePath": "./room_images/Guest_Bedroom.png" },
            { "name": "Nursery", "type": "Bedrooms", "imagePath": "./room_images/Nursery.png" },
            { "name": "Servant's Quarters", "type": "Bedrooms", "imagePath": "./room_images/Servants_Quarters.png" },
            { "name": "Bunk Room", "type": "Bedrooms", "imagePath": "./room_images/Bunk_Room.png" },
            { "name": "Her Ladyship's Chamber", "type": "Bedrooms", "imagePath": "./room_images/Her_Ladyships_Chamber.png" },
            { "name": "Master Bedroom", "type": "Bedrooms", "imagePath": "./room_images/Master_Bedroom.png" },
            { "name": "Hallway", "type": "Hallways", "imagePath": "./room_images/Hallway.png" },
            { "name": "West Wing Hall", "type": "Hallways", "imagePath": "./room_images/West_Wing_Hall.png" },
            { "name": "East Wing Hall", "type": "Hallways", "imagePath": "./room_images/East_Wing_Hall.png" },
            { "name": "Corridor", "type": "Hallways", "imagePath": "./room_images/Corridor.png" },
            { "name": "Passageway", "type": "Hallways", "imagePath": "./room_images/Passageway.png" },
            { "name": "Secret Passage", "type": "Hallways", "imagePath": "./room_images/Secret_Passage.png" },
            { "name": "Foyer", "type": "Hallways", "imagePath": "./room_images/Foyer.png" },
            { "name": "Great Hall", "type": "Hallways", "imagePath": "./room_images/Great_Hall.png" },
            { "name": "Terrace", "type": "Green Rooms", "imagePath": "./room_images/Terrace.png" },
            { "name": "Patio", "type": "Green Rooms", "imagePath": "./room_images/Patio.png" },
            { "name": "Courtyard", "type": "Green Rooms", "imagePath": "./room_images/Courtyard.png" },
            { "name": "Cloister", "type": "Green Rooms", "imagePath": "./room_images/Cloister.png" },
            { "name": "Veranda", "type": "Green Rooms", "imagePath": "./room_images/Veranda.png" },
            { "name": "Greenhouse", "type": "Green Rooms", "imagePath": "./room_images/Greenhouse.png" },
            { "name": "Morning Room", "type": "Green Rooms", "imagePath": "./room_images/Morning_Room.png" },
            { "name": "Secret Garden", "type": "Green Rooms", "imagePath": "./room_images/Secret_Garden.png" },
            { "name": "Commissary", "type": "Shops", "imagePath": "./room_images/Commissary.png" },
            { "name": "Kitchen", "type": "Shops", "imagePath": "./room_images/Kitchen.png" },
            { "name": "Locksmith", "type": "Shops", "imagePath": "./room_images/Locksmith.png" },
            { "name": "Showroom", "type": "Shops", "imagePath": "./room_images/Showroom.png" },
            { "name": "Laundry Room", "type": "Shops", "imagePath": "./room_images/Laundry_Room.png" },
            { "name": "Bookshop", "type": "Shops", "imagePath": "./room_images/Bookshop.png" },
            { "name": "The Armory", "type": "Shops", "imagePath": "./room_images/The_Armory.png" },
            { "name": "Gift Shop", "type": "Shops", "imagePath": "./room_images/Gift_Shop.png" },
            { "name": "Lavatory", "type": "Red Rooms", "imagePath": "./room_images/Lavatory.png" },
            { "name": "Chapel", "type": "Red Rooms", "imagePath": "./room_images/Chapel.png" },
            { "name": "Maid's Chamber", "type": "Red Rooms", "imagePath": "./room_images/Maids_Chamber.png" },
            { "name": "Archives", "type": "Red Rooms", "imagePath": "./room_images/Archives.png" },
            { "name": "Gymnasium", "type": "Red Rooms", "imagePath": "./room_images/Gymnasium.png" },
            { "name": "Darkroom", "type": "Red Rooms", "imagePath": "./room_images/Darkroom.png" },
            { "name": "Weight Room", "type": "Red Rooms", "imagePath": "./room_images/Weight_Room.png" },
            { "name": "Furnace", "type": "Red Rooms", "imagePath": "./room_images/Furnace.png" },
            { "name": "Dovecote", "type": "Uncategorized", "imagePath": "./room_images/Dovecote.png" },
            { "name": "The Kennel", "type": "Uncategorized", "imagePath": "./room_images/The_Kennel.png" },
            { "name": "Clock Tower", "type": "Uncategorized", "imagePath": "./room_images/Clock_Tower.png" },
            { "name": "Classroom", "type": "Uncategorized", "imagePath": "./room_images/Classroom.png" },
            { "name": "Solarium", "type": "Uncategorized", "imagePath": "./room_images/Solarium.png" },
            { "name": "Dormitory", "type": "Uncategorized", "imagePath": "./room_images/Dormitory.png" },
            { "name": "Vestibule", "type": "Uncategorized", "imagePath": "./room_images/Vestibule.png" },
            { "name": "Casino", "type": "Uncategorized", "imagePath": "./room_images/Casino.png" },
            { "name": "Planetarium", "type": "Uncategorized", "imagePath": "./room_images/Planetarium.png" },
            { "name": "Mechanarium", "type": "Uncategorized", "imagePath": "./room_images/Mechanarium.png" },
            { "name": "Treasure Trove", "type": "Uncategorized", "imagePath": "./room_images/Treasure_Trove.png" },
            { "name": "Throne Room", "type": "Uncategorized", "imagePath": "./room_images/Throne_Room.png" },
            { "name": "Tunnel", "type": "Uncategorized", "imagePath": "./room_images/Tunnel.png" },
            { "name": "Conservatory", "type": "Uncategorized", "imagePath": "./room_images/Conservatory.png" },
            { "name": "Lost & Found", "type": "Uncategorized", "imagePath": "./room_images/Lost__Found.png" },
            { "name": "Closed Exhibit", "type": "Uncategorized", "imagePath": "./room_images/Closed_Exhibit.png" },
            { "name": "Toolshed", "type": "Uncategorized", "imagePath": "./room_images/Toolshed.png" },
            { "name": "Shelter", "type": "Uncategorized", "imagePath": "./room_images/Shelter.png" },
            { "name": "Schoolhouse", "type": "Uncategorized", "imagePath": "./room_images/Schoolhouse.png" },
            { "name": "Shrine", "type": "Uncategorized", "imagePath": "./room_images/Shrine.png" },
            { "name": "Root Cellar", "type": "Uncategorized", "imagePath": "./room_images/Root_Cellar.png" },
            { "name": "Hovel", "type": "Uncategorized", "imagePath": "./room_images/Hovel.png" },
            { "name": "Trading Post", "type": "Uncategorized", "imagePath": "./room_images/Trading_Post.png" },
            { "name": "Tomb", "type": "Uncategorized", "imagePath": "./room_images/Tomb.png" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const mainCanvas = document.getElementById('main-canvas');
            const gridContainer = document.getElementById('grid-container');
            const roomListContainer = document.getElementById('room-list');
            const resizableCanvas = document.getElementById('resizable-canvas');
            const shareBtn = document.getElementById('share-btn');
            const clearBtn = document.getElementById('clear-btn');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const contextMenu = document.getElementById('custom-context-menu');
            const planNameInput = document.getElementById('plan-name-input');
            const savePlanBtn = document.getElementById('save-plan-btn');
            const savedPlansList = document.getElementById('saved-plans-list');
            const savedPlansKey = 'roomLayoutPlannerSavedPlans';
            const zoomSlider = document.getElementById('zoom-slider');
            const zoomInput = document.getElementById('zoom-input');
            const resetViewBtn = document.getElementById('reset-view-btn');

            // --- STATE ---
            let currentLayoutString = '';
            let currentContextMenuCell = null;
            let viewState = { scale: 1, isPanning: false, startX: 0, startY: 0, translateX: 0, translateY: 0, panStartX: 0, panStartY: 0 };
            let initialPinchDistance = null;
            const MIN_SCALE = 0.2;
            const MAX_SCALE = 3.0;
            
            // --- INITIALIZATION ---
            const roomsByType = roomData.reduce((acc, room) => {
                (acc[room.type] = acc[room.type] || []).push(room);
                return acc;
            }, {});

            function addDeleteZoneListeners(zone) {
                zone.addEventListener('dragover', (e) => { if (e.dataTransfer.types.includes('text/room-from-grid')) { e.preventDefault(); zone.classList.add('drag-over-delete'); } });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over-delete'));
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over-delete');
                    const movedRoomDataString = e.dataTransfer.getData('text/room-from-grid');
                    if (movedRoomDataString) {
                        const data = JSON.parse(movedRoomDataString);
                        const originCell = document.querySelector(`[data-id='${data.originId}']`);
                        if (originCell) { originCell.innerHTML = ''; updateLayoutInMemory(); }
                    }
                });
            }

            function generateGrid() {
                gridContainer.innerHTML = '';
                const extraCell = document.createElement('div');
                extraCell.className = 'grid-cell extra-cell';
                extraCell.dataset.id = 'extra-0';
                extraCell.style.gridRow = '1';
                extraCell.style.gridColumn = '1';
                addDropListeners(extraCell);
                gridContainer.appendChild(extraCell);

                const deleteZone = document.createElement('div');
                deleteZone.id = 'delete-zone';
                deleteZone.innerHTML = `<div class="p-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-trash mx-auto mb-2" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>Drag Here to Delete</div>`;
                addDeleteZoneListeners(deleteZone);
                gridContainer.appendChild(deleteZone);
                
                const GRID_ROWS = 9, GRID_COLS = 5;
                for (let r = 0; r < GRID_ROWS; r++) {
                    for (let c = 0; c < GRID_COLS; c++) {
                        const cell = document.createElement('div');
                        cell.classList.add('grid-cell');
                        cell.dataset.id = `cell-${r}-${c}`;
                        cell.style.gridRow = `${r + 1}`;
                        cell.style.gridColumn = `${c + 2}`;
                        addDropListeners(cell);
                        gridContainer.appendChild(cell);
                    }
                }
            }
            generateGrid();

            Object.keys(roomsByType).sort().forEach(type => {
                const accordionWrapper = document.createElement('div');
                accordionWrapper.className = 'mb-2 border border-border-color rounded-lg';
                const header = document.createElement('button');
                header.className = 'accordion-header w-full p-2 text-left font-semibold rounded-t-lg focus:outline-none flex justify-between items-center';
                header.innerHTML = `<span>${type}</span><svg class="w-5 h-5 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                const content = document.createElement('div');
                content.className = 'accordion-content p-2 rounded-b-lg';
                content.style.maxHeight = '0px';

                roomsByType[type].forEach(room => {
                    const roomEl = document.createElement('div');
                    roomEl.className = 'room-item-source border rounded-lg';
                    roomEl.draggable = true;
                    roomEl.dataset.roomName = room.name;
                    roomEl.innerHTML = `<div class="flex-grow min-h-0 flex items-center justify-center p-1"><img src="${room.imagePath}" alt="${room.name}" class="max-w-full max-h-full object-contain pointer-events-none"></div><span class="text-xs text-text-color-light block truncate flex-shrink-0 px-1 pb-1 text-center">${room.name}</span>`;
                    addDragListeners(roomEl);
                    content.appendChild(roomEl);
                });

                header.addEventListener('click', () => {
                    const icon = header.querySelector('svg');
                    const isOpening = content.style.maxHeight === '0px';
                    document.querySelectorAll('.accordion-content').forEach(c => c.style.maxHeight = '0px');
                    document.querySelectorAll('.accordion-header svg').forEach(i => i.classList.remove('rotate-180'));
                    if (isOpening) {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.add('rotate-180');
                    }
                });
                
                accordionWrapper.appendChild(header);
                accordionWrapper.appendChild(content);
                roomListContainer.appendChild(accordionWrapper);
            });
            
            loadInitialLayout();
            renderSavedPlans();
            
            // --- UI & EVENT LISTENERS ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.add('hidden'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab === 'rooms' ? 'room-list' : 'options-content').classList.remove('hidden');
                });
            });

            // --- Pan and Zoom ---
            mainCanvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = resizableCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const oldScale = viewState.scale;
                const scaleAmount = -e.deltaY * 0.001;
                const newScale = Math.min(Math.max(MIN_SCALE, oldScale + scaleAmount), MAX_SCALE);
                
                viewState.translateX = mouseX - (mouseX - viewState.translateX) * (newScale / oldScale);
                viewState.translateY = mouseY - (mouseY - viewState.translateY) * (newScale / oldScale);
                viewState.scale = newScale;

                updateCanvasTransform();
                updateZoomControls();
            });

            mainCanvas.addEventListener('mousedown', (e) => {
                if (e.target.closest('.placed-room, .room-item-source, .rotate-btn, button, input, .accordion-header, #zoom-controls')) return;
                e.preventDefault();
                viewState.isPanning = true;
                mainCanvas.classList.add('panning');
                viewState.startX = e.pageX;
                viewState.startY = e.pageY;
                viewState.panStartX = viewState.translateX;
                viewState.panStartY = viewState.translateY;
            });
            
            mainCanvas.addEventListener('mouseleave', () => { viewState.isPanning = false; mainCanvas.classList.remove('panning'); });
            mainCanvas.addEventListener('mouseup', () => { viewState.isPanning = false; mainCanvas.classList.remove('panning'); });
            
            mainCanvas.addEventListener('mousemove', (e) => {
                if (!viewState.isPanning) return;
                e.preventDefault();
                const dx = e.pageX - viewState.startX;
                const dy = e.pageY - viewState.startY;
                viewState.translateX = viewState.panStartX + dx;
                viewState.translateY = viewState.panStartY + dy;
                updateCanvasTransform();
            });

            mainCanvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialPinchDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                }
            });

            mainCanvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && initialPinchDistance) {
                    e.preventDefault();
                    const newDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                    const diff = newDist - initialPinchDistance;
                    const oldScale = viewState.scale;
                    const newScale = Math.min(Math.max(MIN_SCALE, oldScale + diff * 0.005), MAX_SCALE);
                    viewState.scale = newScale;
                    updateCanvasTransform();
                    updateZoomControls();
                    initialPinchDistance = newDist;
                }
            });

             mainCanvas.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) initialPinchDistance = null;
            });

            function updateCanvasTransform() {
                resizableCanvas.style.transform = `translate(${viewState.translateX}px, ${viewState.translateY}px) scale(${viewState.scale})`;
            }

            // --- ZOOM CONTROLS ---
            function updateZoomControls() {
                zoomSlider.value = viewState.scale;
                zoomInput.value = Math.round(viewState.scale * 100);
            }

            zoomSlider.addEventListener('input', () => {
                viewState.scale = parseFloat(zoomSlider.value);
                updateCanvasTransform();
                updateZoomControls();
            });

            zoomInput.addEventListener('change', () => {
                let percent = parseInt(zoomInput.value, 10);
                if (isNaN(percent)) {
                    updateZoomControls();
                    return;
                }
                viewState.scale = Math.min(Math.max(MIN_SCALE, percent / 100), MAX_SCALE);
                updateCanvasTransform();
                updateZoomControls();
            });

            resetViewBtn.addEventListener('click', () => {
                viewState.scale = 1;
                viewState.translateX = 0;
                viewState.translateY = 0;
                updateCanvasTransform();
                updateZoomControls();
            });

            // --- DRAG & DROP LOGIC ---
            let touchGhost = null, draggedRoomName = null, currentDropTarget = null, draggedFromGridInfo = null;
            
            function addDragListeners(el) {
                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', el.dataset.roomName);
                    draggedRoomName = el.dataset.roomName;
                });
                el.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    draggedRoomName = el.dataset.roomName;
                    if (!touchGhost) {
                        const roomInfo = roomData.find(r => r.name === draggedRoomName);
                        touchGhost = document.createElement('img');
                        touchGhost.id = 'touch-ghost';
                        touchGhost.src = roomInfo.imagePath;
                        touchGhost.style.width = '120px';
                        touchGhost.style.height = '120px';
                        document.body.appendChild(touchGhost);
                    }
                    updateGhostPosition(e.touches[0]);
                }, { passive: false });
            }

            function updateGhostPosition(touch) {
                touchGhost.style.left = `${touch.clientX}px`;
                touchGhost.style.top = `${touch.clientY}px`;
                touchGhost.style.display = 'none';
                const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                touchGhost.style.display = 'block';
                if (currentDropTarget && currentDropTarget !== elementUnder) {
                    currentDropTarget.classList.remove('drag-over', 'drag-over-delete');
                }
                const dropTarget = elementUnder ? elementUnder.closest('.grid-cell, #delete-zone') : null;
                if (dropTarget) {
                    currentDropTarget = dropTarget;
                    const overClass = currentDropTarget.id === 'delete-zone' ? 'drag-over-delete' : 'drag-over';
                    currentDropTarget.classList.add(overClass);
                } else {
                    currentDropTarget = null;
                }
            }

            function addDropListeners(cell) {
                cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
                cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drag-over');
                    const movedRoomDataString = e.dataTransfer.getData('text/room-from-grid');
                    if (movedRoomDataString) {
                        const data = JSON.parse(movedRoomDataString);
                        if (data.originId === cell.dataset.id) return;
                        const originCell = document.querySelector(`[data-id='${data.originId}']`);
                        if (originCell) originCell.innerHTML = '';
                        placeRoom(cell, data.roomName, parseInt(data.rotation, 10));
                    } else {
                        const roomName = e.dataTransfer.getData('text/plain');
                        placeRoom(cell, roomName);
                    }
                });
                cell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (cell.querySelector('.placed-room')) {
                        currentContextMenuCell = cell;
                        contextMenu.style.top = `${e.clientY}px`;
                        contextMenu.style.left = `${e.clientX}px`;
                        contextMenu.classList.remove('hidden');
                    }
                });
            }

            function placeRoom(cell, roomName, rotation = 0) {
                const roomInfo = roomData.find(r => r.name === roomName);
                if (!roomInfo) return;
                cell.innerHTML = '';
                const placedRoom = document.createElement('div');
                placedRoom.className = 'placed-room';
                placedRoom.dataset.roomName = roomName;
                placedRoom.dataset.rotation = rotation;
                placedRoom.draggable = true;
                const img = document.createElement('img');
                img.src = roomInfo.imagePath;
                img.alt = roomInfo.name;
                img.style.transform = `rotate(${rotation}deg)`;
                const rotateLeftBtn = document.createElement('button');
                rotateLeftBtn.innerHTML = '&#8634;';
                rotateLeftBtn.className = 'rotate-btn rotate-left';
                rotateLeftBtn.onclick = (e) => { e.stopPropagation(); handleRotate(placedRoom, -90); };
                const rotateRightBtn = document.createElement('button');
                rotateRightBtn.innerHTML = '&#8635;';
                rotateRightBtn.className = 'rotate-btn rotate-right';
                rotateRightBtn.onclick = (e) => { e.stopPropagation(); handleRotate(placedRoom, 90); };
                placedRoom.appendChild(rotateLeftBtn);
                placedRoom.appendChild(img);
                placedRoom.appendChild(rotateRightBtn);
                cell.appendChild(placedRoom);
                addPlacedRoomDragListeners(placedRoom, cell);
                updateLayoutInMemory();
            }
            
            function addPlacedRoomDragListeners(placedRoom, originCell) {
                 placedRoom.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    document.getElementById('delete-zone').style.display = 'flex';
                    const roomDragData = { roomName: placedRoom.dataset.roomName, rotation: placedRoom.dataset.rotation, originId: originCell.dataset.id };
                    e.dataTransfer.setData('text/room-from-grid', JSON.stringify(roomDragData));
                    setTimeout(() => placedRoom.style.opacity = '0.5', 0);
                });
                placedRoom.addEventListener('dragend', () => {
                    placedRoom.style.opacity = '1';
                    document.getElementById('delete-zone').style.display = 'none';
                });
                placedRoom.addEventListener('touchstart', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    document.getElementById('delete-zone').style.display = 'flex';
                    draggedFromGridInfo = { roomName: placedRoom.dataset.roomName, rotation: parseInt(placedRoom.dataset.rotation, 10), originCell: originCell };
                    if (!touchGhost) { 
                        const roomInfo = roomData.find(r => r.name === draggedFromGridInfo.roomName);
                        touchGhost = document.createElement('img');
                        touchGhost.id = 'touch-ghost';
                        touchGhost.src = roomInfo.imagePath;
                        touchGhost.style.width = '120px';
                        touchGhost.style.height = '120px';
                        document.body.appendChild(touchGhost);
                     }
                    placedRoom.style.opacity = '0.5';
                    updateGhostPosition(e.touches[0]);
                }, { passive: false });
            }

            document.addEventListener('touchmove', (e) => { 
                if (!touchGhost) return;
                e.preventDefault();
                updateGhostPosition(e.touches[0]);
            }, { passive: false });
            
            document.addEventListener('touchend', (e) => {
                 if (!touchGhost) return;
                if (draggedFromGridInfo) {
                    const originCell = draggedFromGridInfo.originCell;
                    const originPlacedRoom = originCell.querySelector('.placed-room');
                    if(originPlacedRoom) originPlacedRoom.style.opacity = '1';

                    if (currentDropTarget) {
                        if (currentDropTarget.id === 'delete-zone') {
                            originCell.innerHTML = '';
                            updateLayoutInMemory();
                        } else if (currentDropTarget.classList.contains('grid-cell') && originCell.dataset.id !== currentDropTarget.dataset.id) {
                            originCell.innerHTML = '';
                            placeRoom(currentDropTarget, draggedFromGridInfo.roomName, draggedFromGridInfo.rotation);
                        }
                    }
                    const deleteZone = document.getElementById('delete-zone');
                    if(deleteZone) deleteZone.style.display = 'none';
                    draggedFromGridInfo = null;
                } else if (draggedRoomName) {
                    if (currentDropTarget && currentDropTarget.classList.contains('grid-cell')) {
                        placeRoom(currentDropTarget, draggedRoomName);
                    }
                }
                if(currentDropTarget) currentDropTarget.classList.remove('drag-over', 'drag-over-delete');
                touchGhost.style.opacity = '0';
                setTimeout(() => {
                    if (touchGhost && touchGhost.parentNode) touchGhost.parentNode.removeChild(touchGhost);
                    touchGhost = null;
                    draggedRoomName = null;
                    currentDropTarget = null;
                }, 200);
            });
            
             // --- ACTION BUTTONS & STORAGE ---
            
            clearBtn.addEventListener('click', () => {
                document.querySelectorAll('.grid-cell').forEach(cell => { cell.innerHTML = ''; });
                loadDefaultLayout();
                history.pushState({}, '', window.location.pathname);
            });

            shareBtn.addEventListener('click', () => {
                updateLayoutInMemory();
                const shareUrl = `${window.location.origin}${window.location.pathname}?layout=${currentLayoutString}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    shareBtn.textContent = 'Copied!';
                    shareBtn.classList.remove('btn-green');
                    shareBtn.classList.add('btn-indigo');
                    setTimeout(() => {
                        shareBtn.textContent = 'Copy Link';
                        shareBtn.classList.add('btn-green');
                        shareBtn.classList.remove('btn-indigo');
                    }, 2000);
                });
            });

            planNameInput.addEventListener('input', () => {
                savePlanBtn.disabled = planNameInput.value.trim() === '';
            });

            savePlanBtn.addEventListener('click', saveCurrentPlan);
            
            function saveCurrentPlan() {
                const name = planNameInput.value.trim();
                if (!name) return;
                updateLayoutInMemory();
                const plans = getSavedPlans();
                const existingPlanIndex = plans.findIndex(p => p.name === name);
                if (existingPlanIndex > -1) {
                    plans[existingPlanIndex].layout = currentLayoutString;
                } else {
                    plans.push({ name: name, layout: currentLayoutString });
                }
                localStorage.setItem(savedPlansKey, JSON.stringify(plans));
                planNameInput.value = '';
                savePlanBtn.disabled = true;
                renderSavedPlans();
            }

            function loadPlan(name) {
                const plans = getSavedPlans();
                const planToLoad = plans.find(p => p.name === name);
                if (planToLoad) {
                    loadLayoutFromString(planToLoad.layout);
                    history.pushState({}, '', `${window.location.pathname}?layout=${planToLoad.layout}`);
                }
            }

            function deletePlan(name) {
                let plans = getSavedPlans();
                plans = plans.filter(p => p.name !== name);
                localStorage.setItem(savedPlansKey, JSON.stringify(plans));
                renderSavedPlans();
            }

            function getSavedPlans() {
                try {
                    return JSON.parse(localStorage.getItem(savedPlansKey)) || [];
                } catch (e) {
                    return [];
                }
            }

            function renderSavedPlans() {
                const plans = getSavedPlans();
                savedPlansList.innerHTML = '';
                if (plans.length === 0) {
                    savedPlansList.innerHTML = `<p class="text-sm text-text-color-light text-center">No saved plans yet.</p>`;
                    return;
                }
                plans.forEach(plan => {
                    const item = document.createElement('div');
                    item.className = 'saved-plan-item p-2 rounded flex items-center justify-between';
                    item.innerHTML = `
                        <span class="truncate">${plan.name}</span>
                        <div class="flex gap-2">
                            <button data-action="load" data-name="${plan.name}" class="btn btn-sm btn-blue py-1 px-2">Load</button>
                            <button data-action="delete" data-name="${plan.name}" class="btn btn-sm btn-red py-1 px-2">X</button>
                        </div>`;
                    savedPlansList.appendChild(item);
                });

                savedPlansList.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', () => {
                        const action = button.dataset.action;
                        const name = button.dataset.name;
                        if (action === 'load') loadPlan(name);
                        else if (action === 'delete') deletePlan(name);
                    });
                });
            }

            // --- LAYOUT MANAGEMENT ---
            function updateLayoutInMemory() {
                 const layout = [];
                document.querySelectorAll('.grid-cell').forEach(cell => {
                    const placedRoom = cell.querySelector('.placed-room');
                    if (placedRoom) {
                        const cellId = cell.dataset.id;
                        const roomName = placedRoom.dataset.roomName;
                        const rotation = placedRoom.dataset.rotation;
                        layout.push(`${cellId}:${encodeURIComponent(roomName)}:${rotation}`);
                    }
                });
                currentLayoutString = layout.join('|');
            }
            
            function loadLayoutFromString(layoutString) {
                 document.querySelectorAll('.grid-cell').forEach(cell => { cell.innerHTML = ''; });
                 if (!layoutString) return;
                 layoutString.split('|').forEach(item => {
                    const [cellId, encodedRoomName, rotation] = item.split(':');
                    if (cellId && encodedRoomName && rotation !== undefined) {
                        const cell = document.querySelector(`[data-id='${cellId}']`);
                        if (cell) placeRoom(cell, decodeURIComponent(encodedRoomName), parseInt(rotation, 10));
                    }
                });
            }

            function loadInitialLayout() {
                const urlParams = new URLSearchParams(window.location.search);
                const layoutString = urlParams.get('layout');
                if (layoutString) {
                    loadLayoutFromString(layoutString);
                    // After loading, remove the query params from the URL
                    history.replaceState({}, '', window.location.pathname);
                } else {
                    loadDefaultLayout();
                }
            }

            function loadDefaultLayout() {
                const antechamberCell = document.querySelector("[data-id='cell-0-2']");
                if (antechamberCell) placeRoom(antechamberCell, 'Antechamber', 0);
                const entranceHallCell = document.querySelector("[data-id='cell-8-2']");
                if (entranceHallCell) placeRoom(entranceHallCell, 'Entrance Hall', 0);
            }
            
            // --- CONTEXT MENU ---
            function hideContextMenu() { contextMenu.classList.add('hidden'); currentContextMenuCell = null; }
            contextMenu.addEventListener('click', (e) => {
                if (!currentContextMenuCell) return;
                const action = e.target.closest('button').dataset.action;
                const placedRoom = currentContextMenuCell.querySelector('.placed-room');
                if (action === 'delete') { currentContextMenuCell.innerHTML = ''; updateLayoutInMemory(); }
                else if (action === 'rotate-left' && placedRoom) { handleRotate(placedRoom, -90); }
                else if (action === 'rotate-right' && placedRoom) { handleRotate(placedRoom, 90); }
                hideContextMenu();
            });
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideContextMenu(); });

            function handleRotate(placedRoom, angle) {
                const img = placedRoom.querySelector('img');
                let currentRotation = (parseInt(placedRoom.dataset.rotation || '0', 10) + angle + 360) % 360;
                placedRoom.dataset.rotation = currentRotation;
                img.style.transform = `rotate(${currentRotation}deg)`;
                updateLayoutInMemory();
            }
        });
    </script>
</body>
</html>


